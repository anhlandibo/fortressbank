_format_version: "3.0"

# ============================================================================
# SERVICES & ROUTES
# ============================================================================

services:
- name: user-service
  url: http://user-service:4000
  routes:
  - name: user-service-route
    paths:
    - /users
    - /roles
    - /auth
    strip_path: true

- name: account-service
  url: http://account-service:4001
  routes:
  - name: account-service-route
    paths:
    - /accounts
    strip_path: false

# ============================================================================
# RATE LIMITING CONFIGURATION
# ============================================================================
# Protects against DoS attacks and API abuse
# Tiered approach: strict limits on sensitive operations, relaxed on reads
# ============================================================================

# Global Rate Limiting - Apply to all services as baseline protection
plugins:
- name: rate-limiting
  config:
    minute: 100            # 100 requests per minute per consumer
    hour: 5000             # 5000 requests per hour per consumer
    policy: local          # Use local (memory) policy for performance
    hide_client_headers: false
    fault_tolerant: true   # Continue if rate limit service fails

# Account Service Rate Limiting - Stricter for financial operations
- name: rate-limiting
  service: account-service
  config:
    minute: 60             # 60 requests per minute (tighter for financial ops)
    hour: 2000             # 2000 requests per hour
    policy: local
    hide_client_headers: false
    fault_tolerant: true

# User Service Rate Limiting - Moderate for user management
- name: rate-limiting
  service: user-service
  config:
    minute: 80             # 80 requests per minute
    hour: 3000             # 3000 requests per hour
    policy: local
    hide_client_headers: false
    fault_tolerant: true

# ============================================================================
# AUTHENTICATION CONFIGURATION
# ============================================================================

plugins:
# --- Authentication: OpenID Connect via Keycloak ---
- name: openid-connect
  service: account-service
  config:
    client_id: "kong"
    client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
    discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
    session_secret: "nk7b1GLYLE8XuDXVen2ENvpJo1BrkNGC"
    scope: "openid profile email"
    ssl_verify: false

- name: openid-connect
  service: user-service
  config:
    client_id: "kong"
    client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
    discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
    session_secret: "nk7b1GLYLE8XuDXVen2ENvpJo1BrkNGC"
    scope: "openid profile email"
    ssl_verify: false

# --- Rate Limiting: DoS Protection ---
# Account Service: Stricter limits (financial operations)
- name: rate-limiting
  service: account-service
  config:
    minute: 60              # 60 requests per minute
    hour: 2000              # 2000 requests per hour
    policy: local           # In-memory (fastest, suitable for single Kong node)
    fault_tolerant: true    # Continue if rate limiter fails
    hide_client_headers: false

# User Service: Moderate limits (user management)
- name: rate-limiting
  service: user-service
  config:
    minute: 80              # 80 requests per minute
    hour: 3000              # 3000 requests per hour
    policy: local
    fault_tolerant: true
    hide_client_headers: false