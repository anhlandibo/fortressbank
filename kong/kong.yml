_format_version: "3.0"

services:
  # public auth endpoints
  - name: user-auth-service
    url: http://user-service:4000
    routes:
      - name: user-auth-route
        paths:
          - /auth
        strip_path: false

  # protected user endpoints
  - name: user-main-service
    url: http://user-service:4000
    routes:
      - name: user-main-route
        paths:
          - /users
          - /roles
        strip_path: false

  - name: admin-user-service
    url: http://user-service:4000
    routes:
      - name: admin-user-route
        paths:
          - /admin/users
        strip_path: false

  # public account endpoints (no auth required)
  - name: account-public-service
    url: http://account-service:4001
    routes:
      - name: account-public-route
        paths:
          - /accounts/public
        strip_path: false

  # protected account
  - name: account-service
    url: http://account-service:4001
    routes:
      - name: account-service-route
        paths:
          - /accounts
          - /beneficiaries
          - /cards
        strip_path: false

  # protected transaction service
  - name: transaction-service
    url: http://transaction-service:4004
    routes:
      - name: transaction-service-route
        paths:
          - /transactions
        strip_path: false

  # reference-service
  - name: reference-service
    url: http://reference-service:4003
    routes:
      - name: reference-service-route
        paths:
          - /banks
          - /products
        strip_path: false

  - name: notification-service
    url: http://notification-service:4002
    routes:
      - name: notification-service-route
        paths:
          - /notifications
          - /user-preferences
        strip_path: false

# ============================================================================
# AUTHENTICATION CONFIGURATION
# ============================================================================

plugins:
  # --- Authentication: OpenID Connect via Keycloak ---
  # Single-device enforcement plugin (validates deviceId against Keycloak)
  # - name: single-device
  #   config:
  #     keycloak_url: "http://keycloak:8080"
  #     realm: "fortressbank-realm"
  #     # TODO: replace with a secure service account token or implement OAuth client credentials flow
  #     admin_token: "CHANGE_ME_SINGLE_DEVICE_ADMIN_TOKEN"
  # PROTECT user-main-route ONLY
  - name: openid-connect
    route: user-main-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  - name: openid-connect
    route: admin-user-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe" # Dùng đúng secret của bạn
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # PROTECT account service
  - name: openid-connect
    route: account-service-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  - name: openid-connect
    route: transaction-service-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # Notification service authentication
  - name: openid-connect
    route: notification-service-route
    config:
      client_id: "kong"
      client_secret: "pmFStZwGO8sb0mBDkZmP5niE3wmEELqe"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # GLOBAL rate limit
  # SECURITY NOTE: In production with multiple Kong instances, use policy: redis
  # to share counters across nodes. With policy: local, each node has its own
  # counter which can be exploited by load-balancing across nodes.
  # 
  # SECURITY NOTE: limit_by: ip relies on Kong seeing real client IPs.
  # Configure trusted_ips and real_ip_header in kong.conf when behind a proxy.
  - name: rate-limiting
    config:
      minute: 100
      hour: 5000
      limit_by: consumer  # Changed from ip - requires authentication first
      policy: local  # TODO: Change to redis in production with KONG_REDIS_HOST env var
      fault_tolerant: true
      hide_client_headers: false  # Show rate limit headers for debugging

  # ACCOUNT rate limit - stricter for financial operations
  - name: rate-limiting
    service: account-service
    config:
      minute: 60
      hour: 2000
      limit_by: consumer  # Rate limit per authenticated user, not per IP
      policy: local
      fault_tolerant: true

  # USER rate limit
  - name: rate-limiting
    service: user-main-service
    config:
      minute: 80
      hour: 3000
      limit_by: consumer
      policy: local
      fault_tolerant: true
