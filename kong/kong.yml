_format_version: "3.0"

services:
  # public auth endpoints
  - name: user-auth-service
    url: http://user-service:4000
    routes:
      - name: user-auth-route
        paths:
          - /auth
        strip_path: false

  # protected user endpoints
  - name: user-main-service
    url: http://user-service:4000
    routes:
      - name: user-main-route
        paths:
          - /users
          - /roles
        strip_path: false

  # protected account
  - name: account-service
    url: http://account-service:4001
    routes:
      - name: account-service-route
        paths:
          - /accounts
          - /beneficiaries
          - /cards
        strip_path: false

  # protected transaction service
  - name: transaction-service
    url: http://transaction-service:4004
    routes:
      - name: transaction-service-route
        paths:
          - /transactions
        strip_path: false

  # protected reference-service
  - name: reference-service
    url: http://reference-service:4003
    routes:
      - name: reference-service-route
        paths:
          - /banks
          - /products
        strip_path: false

plugins:
  # PROTECT user-main-route ONLY
  # - name: openid-connect
  #   route: user-main-route
  #   config:
  #     client_id: "kong"
  #     client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
  #     discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
  #     session_secret: "random-secret-here"
  #     scope: "openid profile email"
  #     ssl_verify: false
  #     bearer_only: true
  #     token_endpoint_auth_method: "client_secret_post"
  #     introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  # # PROTECT account service
  # - name: openid-connect
  #   route: account-service-route
  #   config:
  #     client_id: "kong"
  #     client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
  #     discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
  #     session_secret: "random-secret-here"
  #     scope: "openid profile email"
  #     ssl_verify: false

  # PROTECT account service
  # - name: openid-connect
  #   route: transaction-service-route
  #   config:
  #     client_id: "kong"
  #     client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
  #     discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
  #     session_secret: "random-secret-here"
  #     scope: "openid profile email"
  #     ssl_verify: false

  # GLOBAL rate limit
  - name: rate-limiting
    config:
      minute: 100
      hour: 5000
      limit_by: ip
      policy: local
      fault_tolerant: true

  # ACCOUNT rate limit
  - name: rate-limiting
    service: account-service
    config:
      minute: 60
      hour: 2000
      policy: local
      fault_tolerant: true

  # USER rate limit
  - name: rate-limiting
    service: user-main-service
    config:
      minute: 80
      hour: 3000
      policy: local
      fault_tolerant: true
