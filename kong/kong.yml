_format_version: "3.0"

services:
  # public auth endpoints
  - name: user-auth-service
    url: http://user-service:4000
    routes:
      - name: user-auth-route
        paths:
          - /auth
        strip_path: false

  # protected user endpoints
  - name: user-main-service
    url: http://user-service:4000
    routes:
      - name: user-main-route
        paths:
          - /users
          - /roles
        strip_path: false

  - name: admin-user-service
    url: http://user-service:4000
    routes:
      - name: admin-user-route
        paths:
          - /admin/users
        strip_path: false

  # protected account
  - name: account-service
    url: http://account-service:4001
    routes:
      - name: account-service-route
        paths:
          - /accounts
          - /beneficiaries
          - /cards
        strip_path: false

  # protected transaction service
  - name: transaction-service
    url: http://transaction-service:4004
    routes:
      - name: transaction-service-route
        paths:
          - /transactions
        strip_path: false

  # reference-service
  - name: reference-service
    url: http://reference-service:4003
    routes:
      - name: reference-service-route
        paths:
          - /banks
          - /products
        strip_path: false

plugins:
- name: rate-limiting
  config:
    minute: 100            # 100 requests per minute per consumer
    hour: 5000             # 5000 requests per hour per consumer
    policy: local          # Use local (memory) policy for performance
    hide_client_headers: false
    fault_tolerant: true   # Continue if rate limit service fails

# Single-device enforcement plugin (validates deviceId against Keycloak)
- name: single-device
  config:
    keycloak_url: "http://keycloak:8080"
    realm: "fortressbank-realm"
    # TODO: replace with a secure service account token or implement OAuth client credentials flow
    admin_token: "CHANGE_ME_SINGLE_DEVICE_ADMIN_TOKEN"

# Account Service Rate Limiting - Stricter for financial operations
- name: rate-limiting
  service: account-service
  config:
    minute: 60             # 60 requests per minute (tighter for financial ops)
    hour: 2000             # 2000 requests per hour
    policy: local
    hide_client_headers: false
    fault_tolerant: true

# User Service Rate Limiting - Moderate for user management
- name: rate-limiting
  service: user-service
  config:
    minute: 80             # 80 requests per minute
    hour: 3000             # 3000 requests per hour
    policy: local
    hide_client_headers: false
    fault_tolerant: true

# ============================================================================
# AUTHENTICATION CONFIGURATION
# ============================================================================

plugins:
# --- Authentication: OpenID Connect via Keycloak ---
- name: openid-connect
  service: account-service
  config:
    client_id: "kong"
    client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
    discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
    session_secret: "nk7b1GLYLE8XuDXVen2ENvpJo1BrkNGC"
    scope: "openid profile email"
    ssl_verify: false
  # PROTECT user-main-route ONLY
  - name: openid-connect
    route: user-main-route
    config:
      client_id: "kong"
      client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  - name: openid-connect
    route: admin-user-route
    config:
      client_id: "kong"
      client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ" # Dùng đúng secret của bạn
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true

  # PROTECT account service
  - name: openid-connect
    route: account-service-route
    config:
      client_id: "kong"
      client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false
      bearer_only: true
      token_endpoint_auth_method: "client_secret_post"
      introspection_endpoint: "http://keycloak:8080/realms/fortressbank-realm/protocol/openid-connect/token/introspect"

  - name: openid-connect
    route: transaction-service-route
    config:
      client_id: "kong"
      client_secret: "XLODsjH5G3f9iqGftbrkdHeNw3NVfNdZ"
      discovery: "http://keycloak:8080/realms/fortressbank-realm/.well-known/openid-configuration"
      session_secret: "random-secret-here"
      scope: "openid profile email"
      ssl_verify: false

  # GLOBAL rate limit
  - name: rate-limiting
    config:
      minute: 100
      hour: 5000
      limit_by: ip
      policy: local
      fault_tolerant: true

  # ACCOUNT rate limit
  - name: rate-limiting
    service: account-service
    config:
      minute: 60
      hour: 2000
      policy: local
      fault_tolerant: true

  # USER rate limit
  - name: rate-limiting
    service: user-main-service
    config:
      minute: 80
      hour: 3000
      policy: local
      fault_tolerant: true