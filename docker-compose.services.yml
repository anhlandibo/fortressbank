services:
  discovery:
    build:
      context: .
      # FAST LOCAL BUILD
      dockerfile: Dockerfile.services.local
      target: discovery
      # OLD MULTI-STAGE BUILD
      # dockerfile: Dockerfile.services
      # args:
      #   - MAVEN_OPTS=-Xmx512m
    container_name: discovery
    ports:
      - "8761:8761"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      config-server:
        condition: service_healthy
    networks:
      - internal

  config-server:
    build:
      context: .
      # FAST LOCAL BUILD
      dockerfile: Dockerfile.services.local
      target: config-server
      # OLD MULTI-STAGE BUILD
      # dockerfile: config-server/Dockerfile
    container_name: config-server
    ports:
      - "8889:8888"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - internal

  user-service:
    build:
      context: .
      # FAST LOCAL BUILD
      dockerfile: Dockerfile.services.local
      target: user-service
      # OLD MULTI-STAGE BUILD
      # dockerfile: Dockerfile.services
      # args:
      #   - MAVEN_OPTS=-Xmx512m
    container_name: user-service
    environment:
      # Database
      SPRING_DATASOURCE_URL: jdbc:postgresql://user-service-db:5432/${USER_DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}

      # Spring Config
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SERVER_PORT: ${USER_SERVICE_PORT}
      SPRING_CLOUD_CONFIG_URI: ${SPRING_CLOUD_CONFIG_URI}

      # Redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}

      # Email Configuration (SendGrid)
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}

      # OAuth2/JWT
      JWT_ISSUER_URI: ${JWT_ISSUER_URI}
    depends_on:
      discovery:
        condition: service_healthy
      user-service-db:
        condition: service_healthy
      keycloak:
        condition: service_started
      config-server:
        condition: service_started
      redis:
        condition: service_healthy
    ports:
      - "${USER_SERVICE_PORT}:${USER_SERVICE_PORT}"
    networks:
      - internal

  account-service:
    build:
      context: .
      # FAST LOCAL BUILD
      dockerfile: Dockerfile.services.local
      target: account-service
      # OLD MULTI-STAGE BUILD
      # dockerfile: Dockerfile.services
      # args:
      #   - MAVEN_OPTS=-Xmx512m
    container_name: account-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://account-service-db:5432/accountdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_PROFILES_ACTIVE: docker
      SERVER_PORT: 4001
      SPRING_REDIS_HOST: redis
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      JWT_ISSUER_URI: http://keycloak:8080/realms/fortressbank-realm
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
    depends_on:
      discovery:
        condition: service_healthy
      account-service-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      config-server:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    ports:
      - "4001:4001"
    networks:
      - internal

  notification-service:
    build:
      context: .
      # FAST LOCAL BUILD
      dockerfile: Dockerfile.services.local
      target: notification-service
      # OLD MULTI-STAGE BUILD
      # dockerfile: Dockerfile.services
      # args:
      #   - MAVEN_OPTS=-Xmx512m
    container_name: notification-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SERVER_PORT: 4002
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888

      # Datasource configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://notification-service-db:5432/${NOTIFICATION_DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}

      # Email Configuration (SendGrid)
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME}
    depends_on:
      user-service:
        condition: service_started
      account-service:
        condition: service_started
    ports:
      - "4002:4002"
    networks:
      - internal

  transaction-service:
    build:
      context: .
      # FAST LOCAL BUILD
      dockerfile: Dockerfile.services.local
      target: transaction-service
      # OLD MULTI-STAGE BUILD
      # dockerfile: Dockerfile.services
      # args:
      #   - MAVEN_OPTS=-Xmx512m
    container_name: transaction-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://transaction-service-db:5432/transactiondb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_PROFILES_ACTIVE: docker
      SERVER_PORT: 4004
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_ISSUER_URI: http://keycloak:8080/realms/fortressbank-realm
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_CONNECT_ACCOUNT_ID: ${STRIPE_CONNECT_ACCOUNT_ID}
    depends_on:
      discovery:
        condition: service_healthy
      transaction-service-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      config-server:
        condition: service_started
    ports:
      - "4004:4004"
    networks:
      - internal

  audit-service:
    build:
      context: .
      # FAST LOCAL BUILD
      dockerfile: Dockerfile.services.local
      target: audit-service
      # OLD MULTI-STAGE BUILD
      # dockerfile: Dockerfile.services
      # args:
      #   - MAVEN_OPTS=-Xmx512m
    container_name: audit-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://audit-service-db:5432/auditdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_PROFILES_ACTIVE: docker
      SERVER_PORT: 4005
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
    depends_on:
      discovery:
        condition: service_healthy
      audit-service-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      config-server:
        condition: service_started
    ports:
      - "4005:4005"
    networks:
      - internal

  # risk-engine:
  #   build:
  #     context: .
  #     dockerfile: risk-engine/Dockerfile
  #     target: risk-engine
  #     args:
  #       - MAVEN_OPTS=-Xmx512m
  #   container_name: risk-engine
  #   environment:
  #     SPRING_PROFILES_ACTIVE: docker
  #     SERVER_PORT: 6000
  #     SPRING_CLOUD_CONFIG_URI: http://config-server:8888
  #   depends_on:
  #     keycloak:
  #       condition: service_healthy
  #     config-server:
  #       condition: service_healthy
  #     discovery:
  #       condition: service_healthy
  #   ports:
  #     - "6000:6000"
  #   networks:
  #     - internal

  # reference-service:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.services
  #     target: reference-service
  #     args:
  #       - MAVEN_OPTS=-Xmx512m
  #   container_name: reference-service
  #   environment:
  #     SPRING_DATASOURCE_URL: jdbc:postgresql://reference-service-db:5432/referencedb
  #     SPRING_DATASOURCE_USERNAME: postgres
  #     SPRING_DATASOURCE_PASSWORD: 123456
  #     SPRING_PROFILES_ACTIVE: docker
  #     SERVER_PORT: 4003
  #     SPRING_CLOUD_CONFIG_URI: http://config-server:8888
  #   depends_on:
  #     discovery:
  #       condition: service_healthy
  #     reference-service-db:
  #       condition: service_healthy
  #     config-server:
  #       condition: service_started
  #   ports:
  #     - "4003:4003"
  #   networks:
  #     - internal
